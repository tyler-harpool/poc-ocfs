<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Case</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.12/dist/htmx.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.12/dist/ext/json-enc.js"></script>
    <style>
        .group:hover .group-hover\:block {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100">
<div class="container mx-auto p-4">
    <nav class="bg-white shadow p-4 mb-6 flex justify-between items-center">
        <h1 class="text-2xl font-bold">Open Case Filing System</h1>
        <ul class="flex space-x-4">
            <li class="relative group">
                <a href="#" class="text-blue-500 hover:underline">Case Management</a>
                <ul class="absolute hidden group-hover:block bg-white shadow-lg rounded mt-1 space-y-2">
                    <li><a href="all_cases.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">All Cases</a></li>
                    <li><a href="create_case.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Create Case</a></li>
                </ul>
            </li>
            <li><a href="document_management.html" class="text-blue-500 hover:underline">Document Management</a></li>
            <li><a href="time_tracking.html" class="text-blue-500 hover:underline">Time Tracking</a></li>
        </ul>
    </nav>
    <main class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4">Edit Case</h2>
        <div id="message" class="hidden p-4 mb-4 text-sm text-green-700 bg-green-100 rounded-lg"></div>
        <form id="edit-case-form" class="space-y-4" hx-patch="" hx-ext="json-enc" hx-trigger="submit" hx-on="htmx:afterRequest:handleResponse">
            <!-- Form fields will be rendered here -->
        </form>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const caseId = params.get('id');
        if (caseId) {
            fetch(`http://localhost:3002/case_data/${caseId}`)
                .then(response => response.json())
                .then(data => {
                    renderCaseForm(data, caseId);
                })
                .catch(error => console.error('Error loading case data:', error));
        } else {
            console.error('Case ID is missing');
        }
    });

    function renderCaseForm(data, caseId) {
        const form = document.getElementById('edit-case-form');
        form.setAttribute('hx-patch', `http://localhost:3002/case_data/${caseId}`);
        form.innerHTML = `
            <div>
                <label class="block text-sm font-medium text-gray-700">Case Number</label>
                <input type="text" name="case_number" value="${data.case_number}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Client Name</label>
                <input type="text" name="client_name" value="${data.client_name}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Case Type</label>
                <input type="text" name="case_type" value="${data.case_type}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Case Status</label>
                <select name="case_status" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="Open" ${data.case_status === 'Open' ? 'selected' : ''}>Open</option>
                    <option value="Closed" ${data.case_status === 'Closed' ? 'selected' : ''}>Closed</option>
                    <option value="Pending" ${data.case_status === 'Pending' ? 'selected' : ''}>Pending</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Date Opened</label>
                <input type="date" name="date_opened" value="${data.date_opened}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Date Closed</label>
                <input type="date" name="date_closed" value="${data.date_closed}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Assigned Attorney</label>
                <input type="text" name="assigned_attorney" value="${data.assigned_attorney}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Notes</label>
                <textarea name="notes" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" rows="4">${data.notes}</textarea>
            </div>
            <div>
                <button type="submit" hx-patch=http://localhost:3002/case_data/${caseId}\` class="w-full py-2 px-4 bg-blue-500 text-white font-semibold rounded-md shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Save Case</button>
            </div>
        `;
    }

    function handleResponse(evt) {
        const messageDiv = document.getElementById('message');
        if (evt.detail.xhr.status === 200) {
            messageDiv.innerText = 'Case updated successfully!';
            messageDiv.classList.remove('hidden');
            messageDiv.classList.add('block');
        } else {
            messageDiv.innerText = 'Failed to update the case.';
            messageDiv.classList.remove('hidden');
            messageDiv.classList.add('block');
            messageDiv.classList.remove('text-green-700', 'bg-green-100');
            messageDiv.classList.add('text-red-700', 'bg-red-100');
        }
    }

    document.addEventListener('htmx:afterRequest', handleResponse);
</script>
</body>
</html>
